// MATRIX CBS - Prisma Schema
// Verzió: 1.0
// Specifikáció: MATRIX-CBS-Blog-Bovites-FINAL.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// ADMIN FELHASZNÁLÓK
// ============================================
model Admin {
  id           Int       @id @default(autoincrement())
  email        String    @unique @db.VarChar(254)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  name         String    @db.VarChar(100)
  role         AdminRole @default(EDITOR)

  isActive     Boolean   @default(true) @map("is_active")
  lastLogin    DateTime? @map("last_login")

  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Kapcsolatok
  posts        Post[]    @relation("PostAuthor")
  drafts       PostDraft[]
  media        Media[]

  @@map("admins")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  EDITOR
}

// ============================================
// BLOG POSZTOK
// ============================================
model Post {
  id              Int         @id @default(autoincrement())
  title           String      @db.VarChar(200)
  slug            String      @unique @db.VarChar(200)
  content         String      @db.LongText
  excerpt         String?     @db.Text

  // Kiemelt kép
  featuredImage   String?     @map("featured_image") @db.VarChar(500)

  // Státusz és ütemezés
  status          PostStatus  @default(DRAFT)
  publishedAt     DateTime?   @map("published_at")
  scheduledAt     DateTime?   @map("scheduled_at")

  // Előnézet
  previewToken    String?     @unique @map("preview_token") @db.VarChar(64)
  previewExpires  DateTime?   @map("preview_expires")

  // SEO mezők
  metaTitle       String?     @map("meta_title") @db.VarChar(70)
  metaDescription String?     @map("meta_description") @db.VarChar(160)
  canonicalUrl    String?     @map("canonical_url") @db.VarChar(500)

  // Szerző
  authorId        Int         @map("author_id")
  author          Admin       @relation("PostAuthor", fields: [authorId], references: [id])

  // Időbélyegek
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Kapcsolatok
  categories      PostCategory[]
  tags            PostTag[]
  versions        PostVersion[]

  @@index([status, publishedAt])
  @@index([scheduledAt])
  @@index([authorId])
  @@map("posts")
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

// ============================================
// KATEGÓRIÁK
// ============================================
model Category {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(100)
  slug        String    @unique @db.VarChar(100)
  description String?   @db.Text
  color       String?   @db.VarChar(7) // #RRGGBB
  sortOrder   Int       @default(0) @map("sort_order")

  posts       PostCategory[]

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("categories")
}

model PostCategory {
  postId      Int      @map("post_id")
  categoryId  Int      @map("category_id")

  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([postId, categoryId])
  @@map("post_categories")
}

// ============================================
// CÍMKÉK
// ============================================
model Tag {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(50)
  slug        String    @unique @db.VarChar(50)

  posts       PostTag[]

  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("tags")
}

model PostTag {
  postId      Int      @map("post_id")
  tagId       Int      @map("tag_id")

  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag         Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@map("post_tags")
}

// ============================================
// VERZIÓKEZELÉS
// ============================================
model PostVersion {
  id          Int       @id @default(autoincrement())
  postId      Int       @map("post_id")
  post        Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  title       String    @db.VarChar(200)
  content     String    @db.LongText
  excerpt     String?   @db.Text

  versionNum  Int       @map("version_num")
  changeNote  String?   @map("change_note") @db.VarChar(255)

  createdAt   DateTime  @default(now()) @map("created_at")
  createdBy   Int       @map("created_by")

  @@unique([postId, versionNum])
  @@index([postId])
  @@map("post_versions")
}

// ============================================
// AUTOMATIKUS MENTÉS (DRAFT)
// ============================================
model PostDraft {
  id          Int       @id @default(autoincrement())
  postId      Int?      @unique @map("post_id")
  adminId     Int       @map("admin_id")
  admin       Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  title       String?   @db.VarChar(200)
  content     String?   @db.LongText
  excerpt     String?   @db.Text

  savedAt     DateTime  @default(now()) @map("saved_at")

  @@index([adminId])
  @@map("post_drafts")
}

// ============================================
// MÉDIATÁR
// ============================================
model Media {
  id            Int       @id @default(autoincrement())
  filename      String    @db.VarChar(255)
  originalName  String    @map("original_name") @db.VarChar(255)
  mimeType      String    @map("mime_type") @db.VarChar(100)
  size          Int
  width         Int?
  height        Int?
  path          String    @db.VarChar(500)
  thumbnailPath String?   @map("thumbnail_path") @db.VarChar(500)

  alt           String?   @db.VarChar(255)
  caption       String?   @db.Text
  folder        String?   @db.VarChar(100)

  uploadedBy    Int       @map("uploaded_by")
  uploader      Admin     @relation(fields: [uploadedBy], references: [id])

  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([folder])
  @@index([mimeType])
  @@index([uploadedBy])
  @@map("media")
}

// ============================================
// FAQ (GYIK)
// ============================================
model Faq {
  id          Int       @id @default(autoincrement())
  question    String    @db.Text
  answer      String    @db.Text

  category    String?   @db.VarChar(100)
  sortOrder   Int       @default(0) @map("sort_order")
  isActive    Boolean   @default(true) @map("is_active")

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([category])
  @@map("faqs")
}

// ============================================
// LETÖLTHETŐ DOKUMENTUMOK
// ============================================
model Download {
  id            Int       @id @default(autoincrement())
  title         String    @db.VarChar(200)
  description   String?   @db.Text
  filePath      String    @map("file_path") @db.VarChar(500)
  fileName      String    @map("file_name") @db.VarChar(255)
  fileSize      Int       @map("file_size")

  downloadCount Int       @default(0) @map("download_count")
  isActive      Boolean   @default(true) @map("is_active")

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("downloads")
}

// ============================================
// WEB VITALS MONITORING
// ============================================
model WebVital {
  id          Int       @id @default(autoincrement())
  metric      String    @db.VarChar(20) // LCP, FID, CLS, TTFB, INP
  value       Float
  rating      String    @db.VarChar(20) // good, needs-improvement, poor
  path        String    @db.VarChar(500)
  userAgent   String?   @map("user_agent") @db.VarChar(500)

  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([metric])
  @@index([createdAt])
  @@map("web_vitals")
}

// ============================================
// KARBANTARTÁSI MÓD
// ============================================
model MaintenanceMode {
  id          Int       @id @default(autoincrement())
  isActive    Boolean   @default(false) @map("is_active")
  message     String?   @db.Text
  allowedIps  String?   @map("allowed_ips") @db.Text // JSON array

  startedAt   DateTime? @map("started_at")
  endsAt      DateTime? @map("ends_at")

  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("maintenance_mode")
}

// ============================================
// KAPCSOLATI ÜZENETEK
// ============================================
model ContactMessage {
  id          Int       @id @default(autoincrement())
  firstName   String    @map("first_name") @db.VarChar(50)
  lastName    String    @map("last_name") @db.VarChar(50)
  email       String    @db.VarChar(254)
  phone       String?   @db.VarChar(20)
  message     String    @db.Text

  isRead      Boolean   @default(false) @map("is_read")
  isArchived  Boolean   @default(false) @map("is_archived")

  ipAddress   String?   @map("ip_address") @db.VarChar(45)
  userAgent   String?   @map("user_agent") @db.VarChar(500)

  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([isRead])
  @@index([createdAt])
  @@map("contact_messages")
}
